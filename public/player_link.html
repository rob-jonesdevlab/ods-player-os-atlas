<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>ODS Player Link</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#3c83f6" },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"],
                        "mono": ["JetBrains Mono", "monospace"],
                    },
                },
            },
        }
    </script>
    <style>
        html,
        body {
            background-color: #000 !important;
            margin: 0;
            padding: 0;
        }

        body {
            opacity: 0;
            transition: opacity 0.3s ease;
            font-family: 'Inter', -apple-system, sans-serif;
            min-height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            background: url('/resources/designs/ODS_Background.png') center/cover no-repeat fixed;
        }

        body.ready {
            opacity: 1;
        }

        * {
            box-sizing: border-box;
        }

        .glass-card {
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.88) 0%,
                    rgba(255, 255, 255, 0.78) 50%,
                    rgba(255, 255, 255, 0.85) 100%);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.06),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .glass-pill {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.85) 0%, rgba(255, 255, 255, 0.75) 100%);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1), 0 1px 4px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.7);
        }

        /* Split card layout */
        .setup-card {
            display: flex;
            flex-direction: row;
            max-width: 1100px;
            width: 90%;
            min-height: 500px;
            border-radius: 1rem;
            overflow: hidden;
        }

        .card-left {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2.5rem;
            border-right: 1px solid rgba(26, 26, 46, 0.08);
        }

        .card-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 2.5rem 3rem;
        }

        @media (orientation: portrait),
        (max-width: 900px) {
            .setup-card {
                flex-direction: column;
                max-width: 600px;
                min-height: auto;
            }

            .card-left {
                border-right: none;
                border-bottom: 1px solid rgba(26, 26, 46, 0.08);
                padding: 2rem;
            }

            .card-right {
                padding: 2rem;
            }
        }

        .qr-container {
            background: #fff;
            padding: 0.75rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }

        .qr-label {
            font-size: 0.8rem;
            color: #1a1a2e;
            opacity: 0.5;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
        }

        .heading-main {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1a1a2e;
            line-height: 1.2;
            margin-bottom: 0.5rem;
        }

        .heading-accent {
            color: #3c83f6;
        }

        .heading-sub {
            font-size: 1.1rem;
            color: #1a1a2e;
            opacity: 0.6;
            font-weight: 400;
            margin-bottom: 2rem;
        }

        .code-label {
            font-size: 0.7rem;
            color: #3c83f6;
            font-weight: 700;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            margin-bottom: 0.35rem;
        }

        .code-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 4rem;
            font-weight: 700;
            color: #1a1a2e;
            letter-spacing: 0.08em;
            line-height: 1;
            margin-bottom: 2rem;
        }

        .step-list {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .step-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .step-num {
            flex-shrink: 0;
            width: 2.25rem;
            height: 2.25rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .step-num-active {
            background: rgba(60, 131, 246, 0.2);
            color: #3c83f6;
            border: 1px solid rgba(60, 131, 246, 0.3);
        }

        .step-num-inactive {
            background: rgba(26, 26, 46, 0.06);
            color: #1a1a2e;
            border: 1px solid rgba(26, 26, 46, 0.1);
        }

        .step-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a1a2e;
            line-height: 1.3;
        }

        .step-title .url {
            color: #3c83f6;
            font-weight: 600;
        }

        .step-desc {
            font-size: 0.85rem;
            color: #1a1a2e;
            opacity: 0.5;
            margin-top: 0.15rem;
        }

        .main-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            padding-bottom: 7rem;
            z-index: 10;
        }

        .status-footer {
            position: absolute;
            width: 100%;
            display: flex;
            justify-content: center;
            z-index: 10;
            top: 90%;
            transform: translateY(-50%);
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1.75rem;
            border-radius: 9999px;
        }

        .pill-col {
            display: flex;
            flex-direction: column;
        }

        .pill-text {
            color: #111827;
            font-weight: 500;
            font-size: 1.05rem;
        }

        .pill-detail {
            color: #111827;
            font-size: 0.9rem;
            opacity: 0.6;
        }

        .dot-container {
            position: relative;
            width: 0.875rem;
            height: 0.875rem;
        }

        .dot-ping {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 9999px;
            background: #fbbf24;
            opacity: 0.75;
            animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite;
        }

        .dot-solid {
            position: relative;
            width: 0.875rem;
            height: 0.875rem;
            border-radius: 9999px;
            background: #f59e0b;
        }

        @keyframes ping {

            75%,
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        /* State visibility */
        .state-hidden {
            display: none !important;
        }

        /* Spinner */
        .spinner {
            width: 4rem;
            height: 4rem;
            border: 4px solid rgba(60, 131, 246, 0.2);
            border-top-color: #3c83f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Cooldown progress */
        #cooldownProgress {
            transition: width 1s linear;
        }

        /* Error/Cooldown cards */
        .state-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            max-width: 500px;
            width: 90%;
            padding: 3rem;
            border-radius: 1rem;
            gap: 1.5rem;
        }

        .icon-circle {
            width: 5rem;
            height: 5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-circle-red {
            background: rgba(239, 68, 68, 0.15);
            border: 2px solid rgba(239, 68, 68, 0.3);
        }

        .icon-circle-amber {
            background: rgba(245, 158, 11, 0.15);
            border: 2px solid rgba(245, 158, 11, 0.3);
        }

        .retry-btn {
            padding: 0.75rem 2rem;
            background: linear-gradient(to right, #3b82f6, #3c83f6);
            color: white;
            font-weight: 600;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
    <!-- Loading State -->
    <main id="loadingState" class="main-content">
        <div class="glass-card state-card">
            <div class="spinner"></div>
            <div>
                <h2 class="heading-main" style="font-size: 1.5rem; text-align: center;">Initializing device...</h2>
                <p class="heading-sub" style="margin-bottom: 0; text-align: center;">Connecting to pairing server</p>
            </div>
        </div>
    </main>

    <!-- Pairing State -->
    <main id="pairingState" class="main-content state-hidden">
        <div class="glass-card setup-card">
            <!-- Left: QR Code -->
            <div class="card-left">
                <div class="qr-container" id="qrcodeContainer">
                    <div id="qrcode"></div>
                </div>
                <span class="qr-label">Scan to pair instantly</span>
            </div>

            <!-- Right: Content -->
            <div class="card-right">
                <h1 class="heading-main">Pair Your <span class="heading-accent">Device</span></h1>
                <p class="heading-sub">Register this screen to your account</p>

                <p class="code-label">Pairing Code</p>
                <div class="code-value" id="pairingCodeDisplay">--- ---</div>

                <div class="step-list">
                    <div class="step-item">
                        <div class="step-num step-num-active">1</div>
                        <div>
                            <div class="step-title">Scan the QR code or visit <span
                                    class="url">ods-cloud.com/pair</span></div>
                            <div class="step-desc">On your computer or mobile device</div>
                        </div>
                    </div>
                    <div class="step-item">
                        <div class="step-num step-num-inactive">2</div>
                        <div>
                            <div class="step-title">Log in to your ODS Cloud account</div>
                            <div class="step-desc">Create one if you haven't already</div>
                        </div>
                    </div>
                    <div class="step-item">
                        <div class="step-num step-num-inactive">3</div>
                        <div>
                            <div class="step-title">Enter the code above to register this screen</div>
                            <div class="step-desc">Your device will be linked automatically</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Error State -->
    <main id="errorState" class="main-content state-hidden">
        <div class="glass-card state-card">
            <div class="icon-circle icon-circle-red">
                <span class="material-symbols-outlined" style="font-size: 2.5rem; color: #ef4444;">error</span>
            </div>
            <div>
                <h2 class="heading-main" style="font-size: 1.5rem; text-align: center;">Connection Error</h2>
                <p id="errorMessage" class="heading-sub" style="margin-bottom: 0; text-align: center;">
                    Unable to connect to pairing server
                </p>
            </div>
            <button onclick="retryConnection()" class="retry-btn">
                <span style="display: flex; align-items: center; gap: 0.5rem;">
                    <span class="material-symbols-outlined" style="font-size: 1.25rem;">refresh</span>
                    Retry Connection
                </span>
            </button>
        </div>
    </main>

    <!-- Cooldown State -->
    <main id="cooldownState" class="main-content state-hidden">
        <div class="glass-card state-card">
            <div class="icon-circle icon-circle-amber">
                <span class="material-symbols-outlined" style="font-size: 2.5rem; color: #f59e0b;">schedule</span>
            </div>
            <div>
                <h2 class="heading-main" style="font-size: 1.5rem; text-align: center;">Rate Limit Reached</h2>
                <p class="heading-sub" style="margin-bottom: 0; text-align: center;">
                    Too many attempts. Please wait before trying again.
                </p>
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                <span id="cooldownTimer"
                    style="font-family: 'JetBrains Mono', monospace; font-size: 3.5rem; font-weight: 700; color: #f59e0b;">10:00</span>
                <span style="font-size: 0.9rem; color: #1a1a2e; opacity: 0.6;">until next pairing attempt</span>
            </div>
            <div
                style="width: 100%; max-width: 240px; background: rgba(26,26,46,0.08); border-radius: 9999px; height: 0.5rem; margin-top: 0.5rem;">
                <div id="cooldownProgress"
                    style="background: #f59e0b; height: 0.5rem; border-radius: 9999px; width: 100%;"></div>
            </div>
        </div>
    </main>

    <!-- Status Pill -->
    <footer class="status-footer">
        <div id="statusPill" class="glass-pill pill">
            <span id="statusDot" class="dot-container">
                <span class="dot-ping"></span>
                <span class="dot-solid"></span>
            </span>
            <div class="pill-col" id="statusContent">
                <span id="statusText" class="pill-text">Initializing...</span>
                <span id="statusDetails" class="pill-detail"></span>
            </div>
        </div>
    </footer>

    <script>
        // ========================================
        // ENTERPRISE SECURITY: COMPLETE KEYBOARD LOCKDOWN
        // ========================================
        document.addEventListener('keydown', function (e) {
            if (e.ctrlKey && e.altKey && e.shiftKey && e.key === 'O') {
                e.preventDefault(); window.location.href = '/system_config.html'; return;
            }
            if (e.ctrlKey || e.altKey || e.metaKey || e.shiftKey) {
                e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation(); return false;
            }
            if (e.key.startsWith('F') && e.key.length <= 3) { e.preventDefault(); e.stopPropagation(); return false; }
            const blocked = ['Escape', 'PrintScreen', 'ContextMenu'];
            if (blocked.includes(e.key)) { e.preventDefault(); e.stopPropagation(); return false; }
        }, true);
        document.addEventListener('contextmenu', function (e) { e.preventDefault(); return false; }, true);

        // FOUC guard
        function revealPage() { document.body.classList.add('ready'); }
        window.addEventListener('load', revealPage);
        setTimeout(revealPage, 6000);

        // ========================================
        // DEVICE PAIRING LOGIC
        // ========================================
        const API_URL = 'https://api.ods-cloud.com';
        const WS_URL = 'https://api.ods-cloud.com';
        const MAX_PAIRING_CODES = 5;
        const COOLDOWN_DURATION_MS = 10 * 60 * 1000;

        let deviceUuid = null;
        let pairingCode = null;
        let socket = null;
        let pollInterval = null;
        let cooldownInterval = null;

        // State management helpers
        function showState(stateId) {
            ['loadingState', 'pairingState', 'errorState', 'cooldownState'].forEach(id => {
                document.getElementById(id).classList.toggle('state-hidden', id !== stateId);
            });
        }

        // Rate limiting
        function getRateLimitState() {
            try {
                const s = JSON.parse(localStorage.getItem('ods_pairing_rate_limit') || '{}');
                return { count: s.count || 0, cooldownUntil: s.cooldownUntil || 0 };
            } catch { return { count: 0, cooldownUntil: 0 }; }
        }
        function setRateLimitState(s) { localStorage.setItem('ods_pairing_rate_limit', JSON.stringify(s)); }
        function incrementPairingCount() {
            const s = getRateLimitState();
            s.count = (s.count || 0) + 1;
            if (s.count >= MAX_PAIRING_CODES) { s.cooldownUntil = Date.now() + COOLDOWN_DURATION_MS; s.count = 0; }
            setRateLimitState(s);
            return s;
        }
        function isInCooldown() { return getRateLimitState().cooldownUntil > Date.now(); }

        function showCooldown() {
            showState('cooldownState');
            updateStatus('waiting', 'Rate limited', 'Waiting for cooldown');
            const state = getRateLimitState();
            const totalDuration = COOLDOWN_DURATION_MS;
            cooldownInterval = setInterval(() => {
                const remaining = Math.max(0, state.cooldownUntil - Date.now());
                const min = Math.floor(remaining / 60000);
                const sec = Math.floor((remaining % 60000) / 1000);
                document.getElementById('cooldownTimer').textContent = `${min}:${sec.toString().padStart(2, '0')}`;
                const progress = Math.max(0, 100 - ((totalDuration - remaining) / totalDuration * 100));
                document.getElementById('cooldownProgress').style.width = `${progress}%`;
                if (remaining <= 0) {
                    clearInterval(cooldownInterval);
                    setRateLimitState({ count: 0, cooldownUntil: 0 });
                    showState('loadingState');
                    initPairing();
                }
            }, 1000);
        }

        function getDeviceUuid() {
            let uuid = localStorage.getItem('ods_device_uuid');
            if (!uuid) {
                uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                    const r = Math.random() * 16 | 0;
                    return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);
                });
                localStorage.setItem('ods_device_uuid', uuid);
            }
            return uuid;
        }

        function getCpuSerial() {
            let s = localStorage.getItem('ods_cpu_serial');
            if (!s) { s = 'CPU' + Math.random().toString(36).substring(2, 15); localStorage.setItem('ods_cpu_serial', s); }
            return s;
        }

        function updateStatus(state, message, details = '') {
            const dot = document.getElementById('statusDot');
            document.getElementById('statusText').textContent = message;
            const d = document.getElementById('statusDetails');
            if (d) d.textContent = details;
            if (state === 'waiting') {
                dot.innerHTML = `<span class="dot-ping"></span><span class="dot-solid"></span>`;
            } else if (state === 'success') {
                dot.innerHTML = `<span class="dot-solid" style="background:#10b981;"></span>`;
            } else if (state === 'error') {
                dot.innerHTML = `<span class="dot-solid" style="background:#ef4444;"></span>`;
            }
        }

        function retryConnection() {
            showState('loadingState');
            updateStatus('waiting', 'Retrying...', 'Attempting to connect');
            setTimeout(() => initPairing(), 500);
        }

        function showError(message) {
            showState('errorState');
            document.getElementById('errorMessage').textContent = message;
            updateStatus('error', 'Connection error');
        }

        function generateQR(url) {
            const qrDiv = document.getElementById('qrcode');
            qrDiv.innerHTML = '';
            new QRCode(qrDiv, {
                text: url, width: 256, height: 256,
                colorDark: '#0f172a', colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        function startPolling() {
            pollInterval = setInterval(async () => {
                try {
                    const r = await fetch(`${API_URL}/api/pairing/status/${deviceUuid}`);
                    const d = await r.json();
                    if (d.paired) {
                        clearInterval(pollInterval);
                        updateStatus('success', '✓ Paired successfully!');
                        setTimeout(() => { window.location.href = '/player.html'; }, 2000);
                    }
                } catch (e) { console.error('Poll error:', e); }
            }, 5000);
        }

        function initWebSocket() {
            socket = io(WS_URL);
            socket.on('pairing:success', (data) => {
                if (data.device_uuid === deviceUuid) {
                    clearInterval(pollInterval);
                    updateStatus('success', '✓ Paired successfully!');
                    setTimeout(() => { window.location.href = '/player.html'; }, 2000);
                }
            });
        }

        async function initPairing() {
            try {
                if (isInCooldown()) { showCooldown(); return; }
                deviceUuid = getDeviceUuid();
                const cpuSerial = getCpuSerial();
                updateStatus('waiting', 'Connecting...', 'Generating pairing code');

                const response = await fetch(`${API_URL}/api/pairing/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cpu_serial: cpuSerial, device_uuid: deviceUuid })
                });

                if (!response.ok) {
                    const error = await response.json();
                    if (error.paired) { window.location.href = '/player.html'; return; }
                    if (response.status === 429) {
                        const s = getRateLimitState(); s.cooldownUntil = Date.now() + COOLDOWN_DURATION_MS; s.count = 0;
                        setRateLimitState(s); showCooldown(); return;
                    }
                    throw new Error(error.error || 'Failed to generate pairing code');
                }

                const rateLimitState = incrementPairingCount();
                const data = await response.json();
                pairingCode = data.pairing_code;

                showState('pairingState');
                document.getElementById('pairingCodeDisplay').textContent =
                    pairingCode.slice(0, 3) + '-' + pairingCode.slice(3);

                generateQR(data.qr_data);
                updateStatus('waiting', 'Waiting for pairing...',
                    `Code ${rateLimitState.count}/${MAX_PAIRING_CODES}`);
                startPolling();
                initWebSocket();
            } catch (error) {
                console.error('Init error:', error);
                showError(`Error: ${error.message}`);
            }
        }

        // Start
        if (isInCooldown()) { showCooldown(); } else { initPairing(); }
    </script>
</body>

</html>