<!DOCTYPE html>
<html lang="en">

<head>
    <title>Registering Device</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0a0a;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            color: white;
            -webkit-user-select: none;
            user-select: none;
        }

        .container {
            text-align: center;
            max-width: 500px;
            padding: 40px;
        }

        .logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 32px;
            background: linear-gradient(135deg, #ff6b00, #ff8c33);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            font-weight: 700;
        }

        h1 {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .subtitle {
            font-size: 24px;
            color: #aaa;
            margin-bottom: 40px;
        }

        .spinner {
            border: 5px solid rgba(255, 107, 0, 0.2);
            border-top: 5px solid #ff6b00;
            border-radius: 50%;
            width: 72px;
            height: 72px;
            animation: spin 1s linear infinite;
            margin: 32px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #status {
            font-size: 24px;
            color: #ccc;
            min-height: 30px;
        }

        #retry-info {
            font-size: 18px;
            color: #888;
            margin-top: 20px;
        }

        .success {
            color: #4caf50 !important;
        }

        .error {
            color: #f44336 !important;
        }

        .warning {
            color: #ff9800 !important;
        }

        .pairing-code {
            font-size: 56px;
            font-weight: 700;
            letter-spacing: 8px;
            color: #ff6b00;
            margin: 24px 0;
            font-family: monospace;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="logo">O</div>
        <h1>Enrolling Device</h1>
        <p class="subtitle">Connecting to ODS Cloud</p>
        <div class="spinner" id="spinner"></div>
        <div id="status">Initializing...</div>
        <div id="pairing-display"></div>
        <div id="retry-info"></div>
    </div>

    <script>
        const MAX_RETRIES = 5;
        const RETRY_DELAYS = [3000, 5000, 10000, 20000, 30000]; // escalating delays
        let attempt = 0;

        async function enroll() {
            attempt++;
            const status = document.getElementById('status');
            const retryInfo = document.getElementById('retry-info');

            status.textContent = `Registering with ODS Cloud (attempt ${attempt}/${MAX_RETRIES})...`;
            status.className = '';

            try {
                const response = await fetch('/api/enroll', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    document.getElementById('spinner').style.display = 'none';

                    if (data.already_paired) {
                        status.textContent = '✅ Device already paired!';
                        status.className = 'success';
                        retryInfo.textContent = 'Redirecting to player...';
                        setTimeout(() => { window.location.href = '/player_status.html'; }, 2000);
                    } else {
                        status.textContent = '✅ Registered! Pairing code:';
                        status.className = 'success';

                        document.getElementById('pairing-display').innerHTML =
                            `<div class="pairing-code">${data.pairing_code}</div>` +
                            `<p style="font-size:18px;color:#aaa">Enter this code in the ODS Cloud dashboard to pair</p>`;

                        retryInfo.textContent = 'Waiting for pairing...';

                        // Poll for pairing status
                        pollPairingStatus(data.device_uuid);
                    }
                } else {
                    throw new Error(data.error || 'Registration failed');
                }
            } catch (error) {
                if (attempt < MAX_RETRIES) {
                    const delay = RETRY_DELAYS[attempt - 1] || 30000;
                    status.textContent = `⚠️ ${error.message}`;
                    status.className = 'warning';
                    retryInfo.textContent = `Retrying in ${delay / 1000}s (${attempt}/${MAX_RETRIES})...`;
                    setTimeout(enroll, delay);
                } else {
                    status.textContent = `❌ Registration failed after ${MAX_RETRIES} attempts`;
                    status.className = 'error';
                    retryInfo.innerHTML =
                        'Check network connection. ' +
                        '<span style="text-decoration:underline;cursor:pointer" onclick="attempt=0;enroll()">Retry</span>';
                    document.getElementById('spinner').style.display = 'none';
                }
            }
        }

        async function pollPairingStatus(deviceUuid) {
            try {
                const ODS_CLOUD = 'https://api.ods-cloud.com';
                const res = await fetch(`${ODS_CLOUD}/api/pairing/status/${deviceUuid}`);
                const data = await res.json();

                if (data.paired) {
                    document.getElementById('status').textContent = '✅ Paired successfully!';
                    document.getElementById('pairing-display').innerHTML = '';
                    document.getElementById('retry-info').textContent = 'Redirecting to player...';
                    setTimeout(() => { window.location.href = '/player_status.html'; }, 2000);
                } else {
                    // Keep polling every 5 seconds
                    setTimeout(() => pollPairingStatus(deviceUuid), 5000);
                }
            } catch {
                // Retry poll on error
                setTimeout(() => pollPairingStatus(deviceUuid), 10000);
            }
        }

        // Block keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            if (e.ctrlKey && e.altKey && e.shiftKey && e.key === 'O') {
                e.preventDefault();
                window.location.href = '/system_options.html';
                return;
            }
            if (e.ctrlKey && e.altKey && e.shiftKey && e.key === 'I') {
                e.preventDefault();
                window.location.href = '/player_status.html';
                return;
            }
            if (e.ctrlKey && e.altKey && e.shiftKey && e.key === 'K') {
                e.preventDefault();
                fetch('/api/system/restart-signage', { method: 'POST' }).catch(() => { });
                return;
            }
            if (e.ctrlKey || e.altKey || e.metaKey) {
                e.preventDefault();
                e.stopPropagation();
            }
        }, true);

        document.addEventListener('contextmenu', e => e.preventDefault());

        // Start enrollment after 1s
        setTimeout(enroll, 1000);
    </script>
</body>

</html>